<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>優惠券查詢</title>
    <link rel="stylesheet" th:href="@{/web_design/style/style_business.css}" />
    <link
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
            rel="stylesheet"
    />
    <style>

        .container {
            background: #fff;
            padding: 15px;
            margin: auto;
        }
        h3 { margin-bottom: 15px; }
        form {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* Three inputs per row */
            gap: 15px; /* Space between grid items */
            align-items: center; /* Vertically align items */
            margin-left: 50px;
        }
        label { font-weight: bold; }
        input, select {
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 85%;
        }
        .button-container {
            grid-column: span 3;
            display: flex;
            justify-content: flex-end;

        }
        .btn-search{
            padding: 8px 15px;
            background-color: #2c95c6;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-search:hover { background-color: #297a9b; }
        .btn-add-evtCoup{
            padding: 8px 15px;
            background-color: #2c95c6;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-add-evtCoup:hover { background-color: #297a9b; }
        .coupon-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .btn-show-all-evtCoup{
            padding: 8px 15px;
            background-color: #2c95c6;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-show-all-evtCoup:hover { background-color: #297a9b; }
        .btn-revise{
            padding: 3px 8px;
            background-color: #709b29;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 50px;
            font-size: 12px
        }
        .btn-revise:hover { background-color: #536e27; }

        .btn-save{
            padding: 3px 8px;
            background-color: #e8b677;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 50px;
            font-size: 12px
        }

        .btn-save:hover { background-color: #be884f; }

        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
            font-size: 15px;
        }
        th { background-color: #f2f2f2; }


    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="bs-navbar" th:include="homepage_business::navbar"></div>
<main>
    <div class="container">
        <h3>優惠券查詢</h3>
        <form id="searchForm">
            <div>
                <div><label for="eventId">活動名稱</label></div>
                <select id="eventId" name="eventId">
                    <option value="-1" disabled selected hidden>請選擇活動</option>
                    <option th:if="${eventMap.isEmpty()}" value="-1" disabled>尚未建立活動</option>
                    <option th:unless="${eventMap.isEmpty()}"
                            th:each="entry : ${eventMap}"
                            th:value="${entry.key}"
                            th:text="${entry.value}">
                    </option>
                </select>
            </div>
            <div>
                <div><label for="couponName">優惠券名稱</label></div>
                <input type="text" id="couponName" name="couponName" placeholder="輸入優惠券名稱">
            </div>
            <div>
                <div><label for="discountType">折扣類型</label></div>
                <select id="discountType" name="discountType">
                    <option value="-1">選擇折扣類型</option>
                    <option value="0">比例</option>
                    <option value="1">金額</option>
                </select>
            </div>
            <div>
                <div><label for="startDate">適用日期（起）</label></div>
                <input type="datetime-local" id="startDate" name="startDate">
            </div>
            <div>
                <div><label for="endDate">適用日期（迄）</label></div>
                <input type="datetime-local" id="endDate" name="endDate">
            </div>
            <div>
                <div><label for="couponStatus">優惠券狀態</label></div>
                <select id="couponStatus" name="couponStatus">
                    <option value="-1">選擇優惠券狀態</option>
                    <option value="1">上架中</option>
                    <option value="0">已下架</option>
                </select>
            </div>
            <div class="button-container">
                <button type="button" class="btn-search" id="searchBtn">搜尋優惠券</button>
            </div>
        </form>

        <hr style="margin:15px 0px">

        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">優惠券列表</h3>
            <div class="button-container" style="margin: 0px;">
                <button class="btn-add-evtCoup" id="btn-add-evtCoup" style="margin-right: 20px">新增優惠券</button>
                <button class="btn-show-all-evtCoup" id="show-all-evtCoup">顯示所有優惠券</button>
            </div>
        </div>


        <table class="coupon-table">
            <thead>
            <tr>
                <th style="width: 150px">活動名稱</th>
                <th style="width: 230px">優惠券名稱</th>
                <th style="width: 160px">適用日期</th>
                <th style="width: 105px">折扣類型</th>
                <th style="width: 80px">折扣</th>
                <th style="width: 80px">效期</th>
                <th style="width: 100px">適用門檻</th>
                <th style="width: 120px">優惠券狀態</th>
                <th style="width: 70px"></th>
            </tr>
            </thead>
            <tbody id="couponTableBody">
            <!-- Data will be dynamically inserted here -->
            </tbody>
        </table>
    </div>
</main>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // 設定最下方的user control菜單收合
    var el_nav_user_field = document.querySelector(".bs-navbar-user-field");
    el_nav_user_field.addEventListener("click", function (e) {
        e.stopPropagation();
        let el_nav_user_menu = document.querySelector(".bs-navbar-user-menu");
        el_nav_user_menu.classList.toggle("-hidden");
        let el_field_icon = document.querySelector(
            ".bs-navbar-user-field #icon_unfold"
        );
        if (el_field_icon.classList.contains("unfold")) {
            el_field_icon.classList.remove("unfold");
            el_field_icon.innerHTML = "unfold_less";
        } else {
            el_field_icon.classList.add("unfold");
            el_field_icon.innerHTML = "unfold_more";
        }
    });

    // 設定user-item的選取範圍
    var els_nav_user_item = document.querySelectorAll(
        "div.bs-navbar-user-menu .bs-navbar-user-item"
    );
    for (let i = 0; i < els_nav_user_item.length; i++) {
        els_nav_user_item[i].addEventListener("click", function (e) {
            console.log("hi");
            // TODO: 這裡要補上跳轉連結
            this.lastElementChild.click();
            el_nav_user_field.click();
        });
    }

    // 設定nav-item的選取效果
    var els_nav_item = document.querySelectorAll(".bs-navbar-item");
    var els_nav_header = document.querySelectorAll(".bs-navbar-header");
    var els_nav_submenu = document.querySelectorAll(".bs-navbar-submenu");
    var els_nav_subitem = document.querySelectorAll(".bs-navbar-subitem");
    for (let i = 0; i < els_nav_item.length; i++) {
        els_nav_item[i].addEventListener("click", function () {
            els_nav_header.forEach((e) => e.classList.remove("-open"));
            els_nav_submenu.forEach((e) => e.classList.remove("-open"));
            this.firstElementChild.classList.add("-open");
            this.lastElementChild.classList.add("-open");
            // 觸發a tag點擊事件
            this.lastElementChild.click();
        });
    }
    // 設定nav-subitem的選取效果
    for (let i = 0; i < els_nav_subitem.length; i++) {
        els_nav_subitem[i].addEventListener("click", function () {
            els_nav_subitem.forEach((e) => e.classList.remove("-focus"));
            this.classList.add("-focus");
        });
    }
</script>


<script>

    //取得全部優惠券
    $(document).ready(function () {
        // Attach click event to the button
        $('#show-all-evtCoup').on('click', function () {
            $.ajax({
                url: '/business/event/evtCoups', // API endpoint for fetching all coupons
                type: 'GET',
                dataType: 'json', // Expecting JSON response
                success: function (response) {
                    const tbody = $('#couponTableBody');
                    tbody.empty(); // Clear any existing table rows

                    if (response.status === true) {
                        response.data.forEach(coupon => {
                            tbody.append(`
                            <tr>
                                <input type="hidden" name="id" value="${coupon.id}">
                                <td>${coupon.eventName}</td>
                                <td>${coupon.coupName}</td>
                                <td>${coupon.startDate} ~ <div>${coupon.endDate}</div></td>
                                <td>${coupon.type}</td>
                                <td>${coupon.discount > 1 ? coupon.discount +'元' : coupon.discount * 100+'%'}</td>
                                <td>${coupon.duration === null ? '永久' : coupon.duration + '天'}</td>
                                <td>${coupon.threshold === null ? '' : coupon.threshold +'元'}</td>
                                <td>${coupon.status === 1 ? '上架' : '下架'}</td>
                                <td><button id="btn-revise" class="btn-revise">修改</button></td>
                            </tr>
                        `);
                        });
                    } else {
                        const message = response.message;
                        tbody.append(`<tr><td colspan="10">${message}</td></tr>`);
                    }
                },
                error: function () {
                    pupOutAlter('連線異常請稍號再試', 'warning')
                }
            });
        });
    });

    //搜尋優惠券
    $(document).ready(function () {
        $('#searchBtn').on('click', function () {

            if($('#eventId').val() === -1){
                alert('請選擇活動');
            }

            // Gather form data
            const formData = {
                eventId: $('#eventId').val(),
                couponName: $('#couponName').val(),
                discountType: $('#discountType').val(),
                startDate: $('#startDate').val() ==='' ? null : $('#startDate').val(),
                endDate: $('#endDate').val() ==='' ? null : $('#endDate').val(),
                couponStatus: $('#couponStatus').val()
            };

            // Send AJAX request
            $.ajax({
                url: '/business/event/searchCoupons', // Adjust endpoint if necessary
                type: 'GET',
                data: formData, // Send form data as query parameters
                dataType: 'json',
                success: function (response) {
                    const tbody = $('#couponTableBody');
                    tbody.empty(); // Clear existing table rows

                    if (response.status === true) {
                        response.data.forEach(coupon => {
                            tbody.append(`
                            <tr>
                                <input type="hidden" name="id" value="${coupon.id}">
                                <td>${coupon.eventName}</td>
                                <td>${coupon.coupName}</td>
                                <td>${coupon.startDate} ~ ${coupon.endDate}</td>
                                <td>${coupon.type}</td>
                                <td>${coupon.discount > 1 ? coupon.discount +'元' : coupon.discount * 100+'%'}</td>
                                <td>${coupon.duration === null ? '永久' : coupon.duration + '天'}</td>
                                <td>${coupon.threshold === null ? '' : coupon.threshold +'元'}</td>
                                <td>${coupon.status === 1 ? '上架' : '下架'}</td>
                                <td><button id="btn-revise" class="btn-revise">修改</button></td>
                            </tr>
                        `);
                        });
                    } else {
                        const message = response.message;
                        tbody.append(`<tr><td colspan="10">${message}</td></tr>`);
                    }
                },
                error: function () {
                    pupOutAlter('請選擇活動名稱', 'warning')
                }
            });
        });
    });





    //修改優惠券
    $(document).on('click', '.btn-revise', function () {
        const row = $(this).closest('tr');
        const id = row.find('input[name="id"]').val();

        // Convert table cells to editable inputs/selects
        row.find('td').each(function (index) {
            switch (index) {
                case 1: // 優惠券名稱 (text)
                    const evtCoupName = $(this).text();
                    $(this).html(`<input type="text" value="${evtCoupName}" class="form-control">`);
                    break;
                case 2: // 適用日期 (two datetime-local inputs)
                    const dates = $(this).text().split(" ~ ");
                    const startDate = dates[0].trim();
                    const endDate = dates[1].trim();

                    // Ensure the values are in the correct format for datetime-local
                    const formatToDatetimeLocal = (dateStr) => {
                        const date = new Date(dateStr);
                        if (!isNaN(date.getTime())) {
                            // Format the date as yyyy-MM-ddThh:mm
                            return date.toISOString().slice(0, 16);
                        }
                        return ''; // Return empty if invalid date
                    };

                    $(this).html(`
        <input type="datetime-local" class="form-control mb-1" value="${formatToDatetimeLocal(startDate)}">
        <input type="datetime-local" class="form-control" value="${formatToDatetimeLocal(endDate)}">
    `);
                    break;
                case 3: // 折扣類型 (type)
                    $(this).html(`
                    <select class="form-control">
                        <option value="0">比例</option>
                        <option value="1">金額</option>
                    </select>
                `);
                    break;
                case 4: // 折扣 (discount: ratio/ deduction)
                    const discount = $(this).text().replace(/[元%]/g, '');
                    $(this).html(`<input type="number" value="${discount}" class="form-control">`);
                    break;
                case 5: // 效期 (duration)
                    const duration = $(this).text().replace(/天/g, '') || '';
                    $(this).html(`<input type="number" value="${duration}" class="form-control">`);
                    break;

                case 6: // 適用門檻 (threshold)
                    let threshold = $(this).text().replace(/[^\d.-]/g, ''); // Keep only numbers, periods, or minus signs
                    threshold = threshold.trim() === '' ? '' : parseFloat(threshold); // Handle empty or invalid values gracefully
                    $(this).html(`<input type="number" value="${threshold}" class="form-control">`);
                    break;
                case 7: // 優惠券狀態 (status)
                    $(this).html(`
                    <select class="form-control">
                        <option value="0">下架</option>
                        <option value="1">上架</option>
                    </select>
                `);
                    break;
                default:
                    break;
            }
        });

        // Change button to "Save"
        $(this).text('保存').removeClass('btn-revise').addClass('btn-save');
    });

    // Save Changes
    $(document).on('click', '.btn-save', function () {
        const row = $(this).closest('tr');
        const id = parseInt(row.find('input[name="id"]').val());
        const type = parseInt(row.find('td:nth-child(5) select').val());
        const discount = parseInt(row.find('td:nth-child(6) input').val());
        let ratio;

        let deduction;
        if(type === 0){
            ratio = (discount/100).toFixed(2);
            deduction = null
        }
        if(type === 1){
            deduction = discount;
            ratio = null;
        }

        // Validate and gather updated data
        const updatedCoupon = {

            id: id,
            evtCoupName: row.find('td:nth-child(3) input').val(),
            startDate: row.find('td:nth-child(4) input:nth-child(1)').val(),
            endDate: row.find('td:nth-child(4) input:nth-child(2)').val(),
            type: parseInt(row.find('td:nth-child(5) select').val()),
            ratio: ratio,
            deduction: deduction,
            duration: parseInt(row.find('td:nth-child(7) input').val()),
            threshold: parseInt(row.find('td:nth-child(8) input').val()) || null,
            status: parseInt(row.find('td:nth-child(9) select').val()),

        };

        // Validation checks
        if (new Date(updatedCoupon.startDate) > new Date(updatedCoupon.endDate)) {
            pupOutAlter('開始日期不能晚於結束日期', 'warning');
            return;
        }

        if (updatedCoupon.type === 0 && updatedCoupon.ratio >= 1) {
            pupOutAlter('折扣類型為比例時，折扣值需小於100', 'warning');
            return;
        }

        // Send the updated data to the backend
        $.ajax({
            url: '/business/event/coupons/update',
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(updatedCoupon),
            success: function (response) {
                // Update the row with the saved data
                row.find('td:nth-child(3)').text(updatedCoupon.evtCoupName);
                row.find('td:nth-child(4)').text(`${formatDatetimeLocalToDate(updatedCoupon.startDate)} ~ ${formatDatetimeLocalToDate(updatedCoupon.endDate)}`);
                row.find('td:nth-child(5)').text(updatedCoupon.type === 0 ? '比例' : '金額');
                row.find('td:nth-child(6)').text(
                    updatedCoupon.type === 0
                        ? updatedCoupon.ratio*100 + '%'
                        : updatedCoupon.deduction + '元'
                );
                row.find('td:nth-child(7)').text(updatedCoupon.duration + '天');
                row.find('td:nth-child(8)').text(updatedCoupon.threshold ? updatedCoupon.threshold + '元' : '');
                row.find('td:nth-child(9)').text(updatedCoupon.status === 1 ? '上架' : '下架');

                // Change button back to "Modify"
                row.find('.btn-save').text('修改').removeClass('btn-save').addClass('btn-revise');
            },
            error: function () {
                pupOutAlter('更新失敗，請稍後再試','warning');
            },
        });
    });





    //彈窗
    const pupOutAlter = function (title, status){

        Swal.fire({
            title: '',
            text: title,
            icon: status,
            confirmButtonText: 'OK',
            confirmButtonColor: '#2c95c6',
        });
    };

    //日期時間格式轉換
    function formatDatetimeLocalToDate(datetimeLocal) {
        const date = new Date(datetimeLocal); // Parse the datetime-local string
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are zero-based
        const day = String(date.getDate()).padStart(2, '0');

        return `${year}-${month}-${day}`;
    }


</script>


</body>
</html>
